@page "/daxkoapi"
@rendermode InteractiveServer
@using Syncfusion.Blazor
@using Syncfusion.Blazor.Grids
@using Syncfusion.Blazor.Popups
@using Syncfusion.Blazor.Buttons
@using Syncfusion.Blazor.Notifications
@using Syncfusion.Blazor.DropDowns
@using LMWebApp.Models
@using LMWebApp.Services
@inject IDaxkoServiceProvider DaxkoService

<PageTitle>Daxko All Endpoints</PageTitle>

<h2>Daxko Endpoints</h2>
<div>
    <h4>API</h4>
    <label>Select API</label>
    <SfDropDownList TValue="string" TItem="Endpoint" PopupHeight="350px" PopupWidth="350px" Placeholder="Select API" DataSource="@LocalData">
        <DropDownListFieldSettings Value="ID" Text="Text"></DropDownListFieldSettings>
        <DropDownListEvents TValue="string" TItem="Endpoint" ValueChange="OnDropdownChange"></DropDownListEvents>
    </SfDropDownList>
    <p>@APISelected</p>
</div>
<div class="grid-container">
    <h4>API Response</h4>
    @if (isLoading)
    {
        <div class="skeleton-container">
            <SfSkeleton CssClass="skeletonRectangle" Shape=SkeletonType.Rectangle Width="100%" Height="50px"></SfSkeleton>
            <SfSkeleton CssClass="skeletonRectangle" Shape=SkeletonType.Rectangle Width="100%" Height="40px"></SfSkeleton>
            <SfSkeleton CssClass="skeletonRectangle" Shape=SkeletonType.Rectangle Width="100%" Height="40px"></SfSkeleton>
            <SfSkeleton CssClass="skeletonRectangle" Shape=SkeletonType.Rectangle Width="100%" Height="40px"></SfSkeleton>
            <SfSkeleton CssClass="skeletonRectangle" Shape=SkeletonType.Rectangle Width="100%" Height="40px"></SfSkeleton>
            <SfSkeleton CssClass="skeletonRectangle" Shape=SkeletonType.Rectangle Width="100%" Height="40px"></SfSkeleton>
            <SfSkeleton CssClass="skeletonRectangle" Shape=SkeletonType.Rectangle Width="100%" Height="40px"></SfSkeleton>
            <SfSkeleton CssClass="skeletonRectangle" Shape=SkeletonType.Rectangle Width="100%" Height="40px"></SfSkeleton>
        </div>
    }
    else
    {
        <SfGrid ID="Grid" DataSource="@GridData" @ref="Grid" AllowPaging="true" AllowFiltering="true" AllowReordering="true" AllowGrouping="false" AllowExcelExport="true" AllowSelection="true"
                AllowSorting="true" Toolbar="@(new List<string>() { "Details", "CsvExport", "Search" })" Height="80%" Width="100%">
            <GridEditSettings AllowAdding="false" AllowEditing="true" AllowDeleting="false" Mode="Syncfusion.Blazor.Grids.EditMode.Normal"></GridEditSettings>
            <GridFilterSettings Type="Syncfusion.Blazor.Grids.FilterType.FilterBar"></GridFilterSettings>
            <GridPageSettings PageSizes="true"></GridPageSettings>
            <GridSelectionSettings Type="Syncfusion.Blazor.Grids.SelectionType.Single"></GridSelectionSettings>
            <GridEvents OnToolbarClick="ToolbarClick" OnLoad="LoadGrid" TValue="object"></GridEvents>
            <GridColumns>
                <GridColumn Field=@nameof(DaxkoOffering.Id) HeaderText="ID" IsPrimaryKey="true" ValidationRules="@(new ValidationRules { Required = true })" TextAlign="Syncfusion.Blazor.Grids.TextAlign.Right" Width="60"></GridColumn>
                <GridColumn Field=@nameof(DaxkoOffering.Name) HeaderText="Offering Name" ValidationRules="@(new ValidationRules { Required = true })" Width="150"></GridColumn>
                <GridColumn Field=@nameof(DaxkoOffering.Description) HeaderText="Offering Description" ValidationRules="@(new ValidationRules { Required = true })" Width="150"></GridColumn>
                <GridColumn Field=@nameof(DaxkoOffering.Type) HeaderText="Offering Type" ValidationRules="@(new ValidationRules { Required = true })" Width="150"></GridColumn>
                <GridColumn Field=@nameof(DaxkoOffering.StartDate) HeaderText="Offering Start Date" EditType="EditType.DatePickerEdit" Format="d" TextAlign="Syncfusion.Blazor.Grids.TextAlign.Right" Width="90" Type="Syncfusion.Blazor.Grids.ColumnType.Date"></GridColumn>
                <GridColumn Field=@nameof(DaxkoOffering.EndDate) HeaderText="Offering End Date" EditType="EditType.DatePickerEdit" Format="d" TextAlign="Syncfusion.Blazor.Grids.TextAlign.Right" Width="90" Type="Syncfusion.Blazor.Grids.ColumnType.Date"></GridColumn>
            </GridColumns>
        </SfGrid>
    }

    <!-- dialog hidden-->
    <SfDialog @bind-Visible="isReviewVisible" Width="800px" Height="600px" EnableResize="true" IsModal="true" ShowCloseIcon="true">
        <DialogTemplates>
            <Header> Details </Header>
            <Content>
                @APISelected
            </Content>
        </DialogTemplates>
        <DialogButtons>
            <DialogButton IsPrimary="true" OnClick="@OnOk">
                Close
            </DialogButton>
        </DialogButtons>
    </SfDialog>
</div>

@code {
    public List<object>? GridData { get; set; }
    SfGrid<object>? Grid;
    private bool isLoading = true;
    
    protected override async Task OnInitializedAsync()
    {
        isLoading = true;
        
        // Initialize the Daxko service with authentication
        var initSuccess = await DaxkoService.InitAsync();
        if (initSuccess)
        {
            GridData = await DaxkoService.GetRandomAPI(APISelected);
        }
        else
        {
            // Fallback to sample data if initialization fails
            GridData = new List<object>();
        }
        
        isLoading = false;
        StateHasChanged();
    }
    
    public void ToolbarClick(Syncfusion.Blazor.Navigations.ClickEventArgs args)
    {
        if (args.Item.Id == "Grid_csvexport")
        {
            this.Grid?.ExportToCsvAsync();
        }
        else if (args.Item.Id == "Grid_Details")
        {
            if (Grid.SelectedRecords != null && Grid.SelectedRecords.Count > 0)
            {
                CurrentRecord = Grid.SelectedRecords[0];
                OnReview();
            }
        }
    }
    
    public void LoadGrid()
    {
    }
    
    // dialog features
    private bool isReviewVisible { get; set; } = false;
    public object? CurrentRecord { get; set; }
    private string APISelected { get; set; }
    
    private void OnReview()
    {
        this.isReviewVisible = true;   
    }
    
    private async Task OnOk()
    {
        this.isReviewVisible = false;   
    }
    
    // drop down
    public class Endpoint
    {
        public string ID { get; set; }
        public string Text { get; set; }
    }
    List<Endpoint> LocalData = new List<Endpoint> {
        new Endpoint() { ID= "https://demo-api.partners.daxko.com/api/v1/branches/", Text= "Get All Branches" },
        new Endpoint() { ID= "https://demo-api.partners.daxko.com/api/v1/branches/sites", Text= "Get All Sites" },
    };
    
    public async Task OnDropdownChange(ChangeEventArgs<string, Endpoint> args)
    {
        APISelected = $"id = {args.ItemData.ID}, text = {args.ItemData.Text}";
        GridData = await DaxkoService.GetRandomAPI(args.ItemData.ID);
    }
}