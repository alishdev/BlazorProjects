@page "/daxkoapi"
@rendermode InteractiveServer
@using System.Dynamic
@using Syncfusion.Blazor
@using Syncfusion.Blazor.Grids
@using Syncfusion.Blazor.Popups
@using Syncfusion.Blazor.Buttons
@using Syncfusion.Blazor.Notifications
@using Syncfusion.Blazor.DropDowns
@using LMWebApp.Models
@using LMWebApp.Services
@inject IDaxkoServiceProvider DaxkoService

<PageTitle>Daxko All Endpoints</PageTitle>

<h2>Daxko Endpoints</h2>
<div>
    <h4>API</h4>
    <label>Select API</label>
    <SfDropDownList TValue="string" TItem="Endpoint" PopupHeight="350px" PopupWidth="350px" Placeholder="Select API" DataSource="@LocalData">
        <DropDownListFieldSettings Value="ID" Text="Text"></DropDownListFieldSettings>
        <DropDownListEvents TValue="string" TItem="Endpoint" ValueChange="OnDropdownChange"></DropDownListEvents>
    </SfDropDownList>
    <p>@APISelected</p>
</div>
<div class="grid-container">
    <h4>API Response</h4>
    @if (isLoading)
    {
        <div class="skeleton-container">
            <SfSkeleton CssClass="skeletonRectangle" Shape=SkeletonType.Rectangle Width="100%" Height="50px"></SfSkeleton>
            <SfSkeleton CssClass="skeletonRectangle" Shape=SkeletonType.Rectangle Width="100%" Height="40px"></SfSkeleton>
            <SfSkeleton CssClass="skeletonRectangle" Shape=SkeletonType.Rectangle Width="100%" Height="40px"></SfSkeleton>
            <SfSkeleton CssClass="skeletonRectangle" Shape=SkeletonType.Rectangle Width="100%" Height="40px"></SfSkeleton>
            <SfSkeleton CssClass="skeletonRectangle" Shape=SkeletonType.Rectangle Width="100%" Height="40px"></SfSkeleton>
            <SfSkeleton CssClass="skeletonRectangle" Shape=SkeletonType.Rectangle Width="100%" Height="40px"></SfSkeleton>
            <SfSkeleton CssClass="skeletonRectangle" Shape=SkeletonType.Rectangle Width="100%" Height="40px"></SfSkeleton>
            <SfSkeleton CssClass="skeletonRectangle" Shape=SkeletonType.Rectangle Width="100%" Height="40px"></SfSkeleton>
        </div>
    }
    else
    {
        <SfGrid ID="Grid" DataSource="@GridData" @ref="Grid" AllowPaging="true" AllowFiltering="false" AllowReordering="false" AllowGrouping="false" AllowExcelExport="false" AllowSelection="true"
                AllowSorting="true" Toolbar="@(new List<string>() { "Details"})" Height="80%" Width="100%">
            <GridEditSettings AllowAdding="false" AllowEditing="false" AllowDeleting="false" Mode="Syncfusion.Blazor.Grids.EditMode.Normal"></GridEditSettings>
            <GridPageSettings PageSizes="true"></GridPageSettings>
            <GridSelectionSettings Type="Syncfusion.Blazor.Grids.SelectionType.Single"></GridSelectionSettings>
            <GridEvents OnToolbarClick="ToolbarClick" OnLoad="LoadGrid" TValue="ExpandoObject"></GridEvents>
            <GridColumns>
            </GridColumns>
        </SfGrid>
    }

    <!-- dialog hidden-->
    <SfDialog @bind-Visible="isReviewVisible" Width="800px" Height="600px" EnableResize="true" IsModal="true" ShowCloseIcon="true">
        <DialogTemplates>
            <Header> Details </Header>
            <Content>
                @if (CurrentRecord != null)
                {
                    @foreach(KeyValuePair<string, object> property in CurrentRecord as IDictionary<string, object>)
                    {
                        <div class="detail-row">
                            <span class="label">@property.Key</span>
                            <span class="value">@property.Value</span>
                        </div>
                    }
                }
            </Content>
        </DialogTemplates>
        <DialogButtons>
            <DialogButton IsPrimary="true" OnClick="@OnOk">
                Close
            </DialogButton>
        </DialogButtons>
    </SfDialog>
</div>

@code {
    public List<ExpandoObject>? GridData { get; set; }
    SfGrid<ExpandoObject>? Grid;
    private bool isLoading = true;
    
    protected override async Task OnInitializedAsync()
    {
        isLoading = true;
        
        // Initialize the Daxko service with authentication
        var initSuccess = await DaxkoService.InitAsync();
        /*if (initSuccess && !string.IsNullOrEmpty(APISelected))
        {
            GridData = await DaxkoService.GetRandomAPI(APISelected);
        }
        else*/
        {
            // Fallback to sample data if initialization fails
            GridData = new List<ExpandoObject>();
        }
        
        isLoading = false;
        StateHasChanged();
    }
    
    public void ToolbarClick(Syncfusion.Blazor.Navigations.ClickEventArgs args)
    {
        if (args.Item.Id == "Grid_csvexport")
        {
            this.Grid?.ExportToCsvAsync();
        }
        else if (args.Item.Id == "Grid_Details")
        {
            if (Grid.SelectedRecords != null && Grid.SelectedRecords.Count > 0)
            {
                CurrentRecord = Grid.SelectedRecords[0];
                OnReview();
            }
        }
    }
    
    public void LoadGrid()
    {
        
    }
    
    public static string Print(ExpandoObject dynamicObject)
    {
        var dynamicDictionary = dynamicObject as IDictionary<string, object>;

        string cs = "";
        foreach(KeyValuePair<string, object> property in dynamicDictionary)
        {
            cs += $"{property.Key}: {property.Value.ToString()}<br/>";
        }

        return cs;
    }
    
    // dialog features
    private bool isReviewVisible { get; set; } = false;
    public ExpandoObject CurrentRecord { get; set; }
    private string APISelected { get; set; }
    
    private void OnReview()
    {
        this.isReviewVisible = true;   
    }
    
    private async Task OnOk()
    {
        this.isReviewVisible = false;   
    }
    
    // drop down
    public class Endpoint
    {
        public string ID { get; set; }
        public string Text { get; set; }
    }
    List<Endpoint> LocalData = new List<Endpoint> {
        new Endpoint() { ID= "https://demo-api.partners.daxko.com/api/v1/branches/", Text= "Get list of branches" },
        new Endpoint() { ID= "https://demo-api.partners.daxko.com/api/v1/members/me", Text= "Get my member info" },
        new Endpoint() { ID= "https://demo-api.partners.daxko.com/api/v1/members/member_types", Text= "List member types" },
        new Endpoint() { ID= "https://demo-api.partners.daxko.com/api/v1/members/note_types", Text= "Get member-note types" },
        new Endpoint() { ID= "https://demo-api.partners.daxko.com/api/v1/membership/rate_questions", Text= "List rate questions" },
        new Endpoint() { ID= "https://demo-api.partners.daxko.com/api/v1/membership/age_groups", Text= "List age groups" },
        new Endpoint() { ID= "https://demo-api.partners.daxko.com/api/v1/prospects/tour_statuses", Text= "List tour statuses" },
        new Endpoint() { ID= "https://demo-api.partners.daxko.com/api/v1/units/relationships/types", Text= "List Relationship Types" },
    };
    
    public async Task OnDropdownChange(ChangeEventArgs<string, Endpoint> args)
    {
        APISelected = $"id = {args.ItemData.ID}, text = {args.ItemData.Text}";
        var tuple = await DaxkoService.GetRandomAPI(args.ItemData.ID);
        GridData = tuple.Item2;
        Grid.Columns.RemoveAll(x => 1 == 1);
        if (GridData != null && GridData.Count > 0)
        {
            int count = 0;
            foreach (string key in tuple.Item1)
            {
                Grid.Columns.Add(new GridColumn(){AutoFit = true, HeaderText = key, Field=key});
                if (count++ > 5)
                    break;
            }
        }
    }
}